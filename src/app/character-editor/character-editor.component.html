<datalist id="faction-list">
  @for (faction of tup.factions; track faction;) {
    <option [attr.value]="faction"></option>
  }
</datalist>
<datalist id="health-sphere-list">
  @for (sphere of tup.spheres; track sphere;) {
    @if (sphere[1]) {
      <option [attr.value]="sphere[0]"></option>
    }
  }
</datalist>
<datalist id="morale-sphere-list">
  @for (sphere of tup.spheres; track sphere;) {
    @if (sphere[2]) {
      <option [attr.value]="sphere[0]"></option>
    }
  }
</datalist>
<div *ngIf="mode != 'off' && canSave" class="character-sheet-wrap" [ngClass]="'mode-' + mode" [formGroup]="formGroup">
<section class="config" *ngIf="mode == 'edit'">
  <h1 class="head">Edit Character</h1>
  <div *ngIf="showConfig">
    <div *ngIf="showAdvConfig" class="subgrid">
      <div><label><input type="number" formControlName="configInvestigativeBuild"> Base Investigative Build Points</label></div>
      <div><label><input type="number" formControlName="configGeneralBuild"> General Build Points</label></div>
      <div><label><input type="number" formControlName="configStaminaBuild"> Stamina Build Points</label></div>
      <div><label><input type="number" formControlName="configMinStamina"> Minimum Stamina</label></div>
      <div><label><input type="number" formControlName="configFreeAllies"> Free Allies</label></div>
      <div><label><input type="number" formControlName="configFreeEnemies"> Free Enemies</label></div>
    </div>
    <div class="wide"><button (click)="showAdvConfig = !showAdvConfig">⚙️</button></div>
    <div><label><input type="checkbox" formControlName="configS2S"> Session 2 started</label></div>
    <div><label><input type="number" formControlName="configCharacterCount"> Number of Heroes</label></div>
    <div><label><input type="number" formControlName="advancement"> Advancement Points</label></div>
    <div class="message incomplete" *ngIf="unspentAdvancement > 0">
      <div [ngPlural]="unspentAdvancement">
        <ng-template ngPluralCase="one">1 unspent Advancement Point</ng-template>
        <ng-template ngPluralCase="other">{{ unspentAdvancement }} unspent Advancement Points</ng-template>
      </div>
    </div>
    <div class="message error" *ngIf="unspentAdvancement < 0">
      <div [ngPlural]="-unspentAdvancement">
        <ng-template ngPluralCase="one">1 unspent overspent Point</ng-template>
        <ng-template ngPluralCase="other">{{ -unspentAdvancement }} overspent Advancement Points</ng-template>
      </div>
    </div>
  </div>
</section>
<section class="config" *ngIf="mode == 'play'">
  <h1 class="head">Play Character</h1>
</section>
<section class="config" *ngIf="mode == 'print'">
  <h1 class="head">Print Character</h1>
</section>
<section class="view">
  <button (click)="showConfig = !showConfig" [disabled]="(mode == 'play' || mode == 'print') ? 'disabled' : ''">⚙️</button>
  <button (click)="mode = 'edit'">Edit</button>
  <button (click)="mode = 'play'">Play</button>
  <button (click)="mode = 'print'">Print</button>
</section>
<div class="character-edit-grid character-sheet">
  <div class="panel name-panel">
    <div class="name-field">
      <label>
        <div class="label">Name</div>
        <div class="input">
          @if (mode == 'edit') {
            <input type="text" formControlName="name" class="large">
          } @else {
            <span>{{ formGroup.controls.name.value }}</span>
          }
        </div>
      </label>
    </div>
    <div class="true-name-known-field">
      <label>
        <div class="label">True Name? <input type="checkbox" formControlName="tnk"></div>
        <div class="note">Check if True Name is known</div>
      </label>
    </div>
    <div class="profession-field">
      <label>
        <div class="label">Profession</div>
        <div class="input">
          @if (mode == 'edit') {
            <input type="text" formControlName="profession" class="large">
          } @else {
            <span>{{ formGroup.controls.profession.value }}</span>
          }
        </div>
      </label>
    </div>
    <div class="adjectives-field">
      <div class="label">Adjectives</div>
      @if (mode == 'edit') {
        @for (i of aii(adjectives.length); track i;) {
          <div class="input">
            <input type="text" [ngModel]="adjectives[i]" (ngModelChange)="setAdjective(i, $event)" [ngModelOptions]="{standalone: true}">
            <button class="del" (click)="delAdjective(i)">−</button>
          </div>
        }
        <div class="add" *ngIf="adjectives.length < 5"><button (click)="addAdjective()">+</button></div>
      } @else {
        <div class="input"><span>{{ adjectives.join(', ') }}</span></div>
      }
    </div>
  </div>
  <div class="logo"><img src="assets/logo.png" alt="Swords of the Serpentine"></div>
  <div class="panel portrait-panel">
    <div class="flex-column">
      <div class="head label">Character Portrait</div>
      <div class="input flex" [ngClass]="(mode == 'edit') ? '' : 'invisible'"><div>URL:</div><input type="url" formControlName="portraitUrl"></div>
      <div class="portrait" [ngStyle]="{'background-image': 'url(' + formGroup.controls.portraitUrl.value + ')'}"></div>
    </div>
  </div>
  <div class="panel drives-panel">
    <div>
      <div class="head label">What is Best in Life?</div>
      <div class="message error" *ngIf="mode == 'edit' && drivesEntered < 3">
        <div [ngPlural]="3 - drivesEntered">
          <ng-template ngPluralCase="one">1 Drive not selected</ng-template>
          <ng-template ngPluralCase="other">{{ 3 - drivesEntered }} Drives not selected</ng-template>
        </div>
      </div>
      <div class="flex-column">
        @for (drive of drives; track drive;) {
          <div class="input">
            @if (mode == 'edit') {
              <div class="circle spacer"></div>
              <input type="text" [ngModel]="drive.value" (ngModelChange)="setDrive(drive, $event)" [ngModelOptions]="{standalone: true}">
            } @else {
              @if (mode == 'play') {
                <div class="circle" [ngClass]="(drive.pool >= 1) ? ' filled' : ''" (click)="drive.pool = (drive.pool == 1) ? 0 : 1"></div>
              } @else if (mode == 'print') {
                <div class="circle" ></div> 
              }
              <div class="value">{{ drive.value }}</div>
            }
          </div>
        }
      </div>
    </div>
  </div>
  <section class="investigative-abilities subgrid">
    <div class="title1">
      <h4><span>Investigative Abilities</span></h4>
      <div class="faux-grid-below" *ngIf="mode == 'edit' && invUnspent != 0">
        <div class="message incomplete" *ngIf="mode == 'edit' && invUnspent > 0">
          <div [ngPlural]="invUnspent">
            <ng-template ngPluralCase="one">1 unspent Investigative Build Point</ng-template>
            <ng-template ngPluralCase="other">{{ invUnspent }} unspent Investigative Build Points</ng-template>
          </div>
        </div>
        <div class="message error" *ngIf="mode == 'edit' && invUnspent < 0">
          <div [ngPlural]="-invUnspent">
            <ng-template ngPluralCase="one">1 overspent Investigative Build Point</ng-template>
            <ng-template ngPluralCase="other">{{ -invUnspent }} overspent Investigative Build Points</ng-template>
          </div>
        </div>
      </div>
    </div>
    @for (category of invCatNames; track category) {
      <div class="panel" [ngClass]="category.toLowerCase() + '-panel'">
        <div>
          <h5 class="head">{{ category }}</h5>
          @for (ability of invNames(category); track ability;) {
            <div class="ability">
              <div class="ability-name">{{ ability }}</div>
              @if (invDef(category, ability)!.healthMorale) {
                <div class="label-tiny" *ngIf="invAbilities[category][ability].ranks == 1">
                  @if (mode == 'edit') {
                    <div><label><input type="radio" formControlName="spotFrailty" value="Health"> Health</label></div>
                    <div><label><input type="radio" formControlName="spotFrailty" value="Morale"> Morale</label></div>
                  } @else {
                    <div>{{ formGroup.controls.spotFrailty.value }}</div>
                  }
                </div>
              }
              <div class="ability-value">
                @if (mode == 'edit') {
                  <div *ngFor="let i of aiToFrom(5)">
                    <div
                      class="circle"
                      [ngClass]="(invAbilities[category][ability].ranks >= i) ? ' filled' : ''"
                      (click)="setInvAbility(category, ability, i)"
                    ></div>
                  </div>
                } @else {
                  <div *ngFor="let i of aiToFrom(5)">
                    @if (invAbilities[category][ability].ranks >= i) {
                      @if (mode == 'play') {
                        @if (invAbilities[category][ability].pool >= i) {
                          <div class="circle filled" (click)="adjustInvPool(category, ability, false)"></div>
                        } @else {
                          <div class="circle" (click)="adjustInvPool(category, ability)"></div>
                        }
                      } @else if (mode == 'print') {
                        <div class="circle"></div>
                      }
                    } @else {
                      <div class="circle spacer"></div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    }
  </section>
  <h4 class="title2"><span>General Abilities</span></h4>
  <h4 class="title3"><span>Allegiances</span></h4>
  <div class="general-section flex-panel-wrap">
    <div class="faux-grid-above" *ngIf="mode == 'edit' && genUnspent != 0 || genTooHigh || sorcWithoutCorr">
      <div class="message incomplete" *ngIf="mode == 'edit' && genUnspent > 0">
        <div [ngPlural]="genUnspent">
          <ng-template ngPluralCase="one">1 unspent General Build Point</ng-template>
          <ng-template ngPluralCase="other">{{ genUnspent }} unspent General Build Points</ng-template>
        </div>
      </div>
      <div class="message error" *ngIf="mode == 'edit' && genUnspent < 0">
        <div [ngPlural]="-genUnspent">
          <ng-template ngPluralCase="one">1 overspent General Build Point</ng-template>
          <ng-template ngPluralCase="other">{{ -genUnspent }} overspent General Build Points</ng-template>
        </div>
      </div>
      <div class="message error" *ngIf="mode == 'edit' && genTooHigh">Highest General Ablility cannot be more than twice the next highest.</div>
      <div class="message error" *ngIf="mode == 'edit' && sorcWithoutCorr">Sorcery has ranks but Corruption does not.</div>
    </div>
    <div class="panel">
      <div>
        @for (ability of genAbilityDefs; track ability;) {
          <div class="ability" [ngClass]="(ability.combat ? ' combat' : '') + ((mode == 'edit' && ability.name == 'Sorcery' && invAbilities['Sorcerer']['Corruption'].ranks == 0) ? ' disabled' : '')">
            <div class="ability-name">{{ ability.name }}</div>
            <div class="general-ability">
              <div class="ability-value">
                <div *ngFor="let i of aiToFrom(15)">
                  @if (mode == 'edit') {
                    @if (ability.name == 'Sorcery' && invAbilities['Sorcerer']['Corruption'].ranks == 0) {
                      <div class="circle" [ngClass]="i == 8 ? ' talent' : ''"></div>
                    } @else {
                      <div
                        class="circle"
                        [ngClass]="((genAbilities[ability.name].ranks >= i) ? ' filled' : '') + (i == 8 ? ' talent' : '')"
                        (click)="setGenAbility(ability.name, i)"
                      >{{ curGenRank(ability.name, i) }}</div>
                    }
                  } @else {
                    @if (genAbilities[ability.name].ranks >= i && (ability.name != 'Sorcery' || invAbilities['Sorcerer']['Corruption'].ranks != 0)) {
                      @if (mode == 'play') {
                        <div
                          class="circle"
                          [ngClass]="(genAbilities[ability.name].pool >= i) ? ' filled' : ''"
                          (click)="adjustGenPool(ability.name, genAbilities[ability.name].pool < i)"
                        >
                          {{ curGenRank(ability.name, i) }}
                        </div>
                      } @else if (mode == 'print') {
                        <div class="circle">{{ curGenRank(ability.name, i) }}</div>
                      }

                    } @else {
                      <div class="circle spacer"></div>
                    }
                  }
                </div>
              </div>
              <div *ngIf="mode == 'edit' || genAbilities[ability.name].ranks >= 8" class="talent-name" [ngClass]="(genAbilities[ability.name].ranks < 8) ? ' disabled' : ''">{{ ability.talent }}</div>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
  <div class="allegiances-section flex-panel-wrap">
    <div class="faux-grid-above" *ngIf="mode == 'edit' && (freeAllies != 0 || freeEnemies != 0 || blankFactions > 0)">
      <div class="message error" *ngIf="mode == 'edit' && (freeAllies > 0)">
        <div [ngPlural]="freeAllies">
          <ng-template ngPluralCase="one">1 unassigned Ally</ng-template>
          <ng-template ngPluralCase="other">{{ freeAllies }} unassigned Allies</ng-template>
        </div>
      </div>
      <div class="message error" *ngIf="mode == 'edit' && freeEnemies > 0">
        <div [ngPlural]="freeEnemies">
          <ng-template ngPluralCase="one">1 unassigned Enemy</ng-template>
          <ng-template ngPluralCase="other">{{ freeEnemies }} unassigned Enemies</ng-template>
        </div>
      </div>
      <div class="message error" *ngIf="mode == 'edit' && blankFactions > 0">
        <div [ngPlural]="blankFactions">
          <ng-template ngPluralCase="one">1 Faction not selected</ng-template>
          <ng-template ngPluralCase="other">{{ blankFactions }} Factions not selected</ng-template>
        </div>
      </div>
    </div>
    <div class="panel">
      <div>
        @for (_ of allegiances; track _; let i = $index) {
          <div class="input">
            @if (mode == 'edit') {
              <input type="text" class="allegiances" [ngModel]="allegiances[i].name" (ngModelChange)="setAllegiance(i, $event)" [ngModelOptions]="{standalone: true}" list="faction-list" />
              <div>
                <div class="ability-value">
                  <div *ngFor="let j of aiToFrom(5)">
                    <div
                      class="circle"
                      [ngClass]="(allegiances[i].ally.ranks >= j) ? ' filled' : ''"
                      (click)="setAlly(i, j)"
                    >A</div>
                  </div>
                </div>
                <div class="ability-value">
                  <div *ngFor="let j of aiToFrom(5)">
                    <div
                      class="circle red"
                      [ngClass]="(allegiances[i].enemy.ranks >= j) ? ' filled' : ''"
                      (click)="setEnemy(i, j)"
                    >E</div>
                  </div>
                </div>
              </div>
              <button class="del" (click)="delAllegiance(i)">−</button>
            } @else {
              <div>{{ allegiances[i].name }}</div>
              <div>
                <div class="ability-value">
                  <div *ngFor="let j of aiToFrom(allegiances[i].ally.ranks)">
                    @if (mode == 'play') {
                      @if (allegiances[i].ally.pool >= j) {
                        <div class="circle filled" (click)="adjustAllyPool(i, false)">A</div>
                      } @else {
                        <div class="circle" (click)="adjustAllyPool(i)">A</div>
                      }
                    } @else if (mode == 'print') {
                      <div class="circle">A</div>
                    }
                  </div>
                  <div
                    *ngFor="let j of aiToFrom(allegiances[i].enemy.ranks)"
                    class="circle red"
                    [ngClass]="(mode == 'play' && allegiances[i].enemy.pool >= j) ? ' filled' : ''"
                  >E</div>
                </div>
              </div>
            }
          </div>
        }
        <div *ngIf="mode == 'edit' && allegiances.length < 12" class="add"><button (click)="addAllegiance()">+</button></div>
      </div>
    </div>
  </div>
  <div class="panel wealth-panel">
    <label class="flex">
      <div class="label">Wealth</div>
      <input type="number" formControlName="wealth">
    </label>
    <div class="lifestyle">
      <div class="label">Lifestyle</div>
      @if (mode == 'edit' || mode == 'play') {
        <div>{{ tup.lifestyle[lifestyle + 2] }}</div>
        <div class="ability-value">
          <div class="circle" [ngClass]="(lifestyle <= -2) ? ' filled' : ''" (click)="lifestyle = -2">−2</div>
          <div class="circle" [ngClass]="(lifestyle <= -1) ? ' filled' : ''" (click)="lifestyle = -1">−1</div>
          <div class="circle filled" (click)="lifestyle = 0">0</div>
          <div class="circle" [ngClass]="(lifestyle >= 1) ? ' filled' : ''" (click)="lifestyle = 1">+1</div>
          <div class="circle" [ngClass]="(lifestyle >= 2) ? ' filled' : ''" (click)="lifestyle = 2">+2</div>
        </div>
      } @else if (mode == 'print') {
        <div>_________________</div>
        <div class="ability-value">
          <div class="circle"></div>
          <div class="circle"></div>
        </div>
      }
    </div>
  </div>
  <div class="stamina-section">
    <div *ngIf="mode == 'edit' && (staminaUnspent != 0)">
      <div class="message error" *ngIf="mode == 'edit' && staminaUnspent > 0">
        <div [ngPlural]="staminaUnspent">
          <ng-template ngPluralCase="one">1 unspent Stamina Build Point</ng-template>
          <ng-template ngPluralCase="other">{{ staminaUnspent }} unspent Stamina Build Points</ng-template>
        </div>
      </div>
      <div class="message error" *ngIf="mode == 'edit' && staminaUnspent < 0">
        <div [ngPlural]="-staminaUnspent">
          <ng-template ngPluralCase="one">1 overspent Stamina Build Point</ng-template>
          <ng-template ngPluralCase="other">{{ -staminaUnspent }} overspent Stamina Build Points</ng-template>
        </div>
      </div>
    </div>
    <div class="flex">
      <div class="panel grid">
        @for (s of ['Health', 'Morale']; track s) {
          <div class="label">{{ s }}</div>
          <div class="ability-value">
            @if (mode == 'edit') {
              <div *ngFor="let i of aiToFrom(15)">
                <div
                  class="circle"
                  [ngClass]="(genAbilities[s].ranks >= i) ? ' filled' : ''"
                  (click)="setGenAbility(s, i)"
                >
                 {{ curGenRank(s, i) }}
                </div>
              </div>
            } @else {
              <div *ngFor="let i of aiToFrom(15, -12)">
                @if (genAbilities[s].ranks >= i) {
                  @if (mode == 'play') {
                    <div
                      class="circle"
                      [ngClass]="((genAbilities[s].pool >= i) ? ' filled' : '') + ' ' + staminaPlayColor(i)"
                      (click)="adjustGenPool(s, genAbilities[s].pool < i)"
                    >
                      {{ curGenPool(s, i) }}
                    </div>
                  } @else if (mode == 'print') {
                    <div class="circle" [ngClass]="staminaPrintColor(i)">{{ fmt(i) }}</div>
                  }
                } @else {
                  <div class="circle spacer"></div>
                }
              </div>
            }
          </div>
        }
      </div>
      <div class="table">
        <div class="label">Threshold</div>
        <div class="label">Armor</div>
        <div class="value">{{ (genAbilities['Health'].ranks > 9) ? 4 : 3 }}</div>
        <div class="value">{{ armor }}</div>
        <div class="value">{{ (genAbilities['Morale'].ranks > 9) ? 4 : 3 }}</div>
        <div class="value">{{ grit }}</div>
        <div class="label">Threshold</div>
        <div class="label">Grit</div>
      </div>
    </div>
  </div>
  <h4 class="title2"><span>Gear</span></h4>
  <h4 class="title3"><span>Sorcerous Spheres</span></h4>
  <div class="panel gear-panel">
    <div>
      @if (mode == 'edit') {
        @for (_ of gear; track _; let i = $index) {
          <div class="input">
            <input type="checkbox" class="gear" [ngModel]="gear[i].iconic" (ngModelChange)="setGearIconic(i, $event)" [ngModelOptions]="{standalone: true}">
            <input type="text" class="gear" [ngModel]="gear[i].value" (ngModelChange)="setGear(i, $event)"  [ngModelOptions]="{standalone: true}">
            <button class="del" (click)="delGear(i)">−</button>
          </div>
        }
        <div class="add" *ngIf="gear.length < 10"><button (click)="addGear()">+</button></div>
      } @else {
        @for (_ of gear; track _; let i = $index) {
          @if (gear[i].iconic) {
            <div class="gear">{{ gear[i].value }}</div>
          }
        }
        <div class="gear">{{ nonIconicGear }}</div>
      }
    </div>
  </div>
  <div class="spheres-section flex-panel-wrap">
    <div class="faux-grid-above" *ngIf="mode == 'edit' && (spheresUnspent != 0)">
      <div class="message error" *ngIf="mode == 'edit' && spheresUnspent > 0">
        <div [ngPlural]="spheresUnspent">
          <ng-template ngPluralCase="one">1 Sorcerous Sphere not selected</ng-template>
          <ng-template ngPluralCase="other">{{ spheresUnspent }} Sorcerous Spheres not selected</ng-template>
        </div>
      </div>
    </div>
    <div class="panel">
      <div>
        @if (invAbilities['Sorcerer']['Corruption'].ranks > 0) {
          <div class="label-tiny center">
            Affects:
            @if (mode == 'edit') {
              <label><input type="radio" formControlName="sorceryAffects" value="Health" /> Health </label>
              <label><input type="radio" formControlName="sorceryAffects" value="Morale" /> Morale </label>
            } @else {
              {{ formGroup.controls.sorceryAffects.value }}
            }
          </div>
        }
        @for (i of aiToFrom(invAbilities['Sorcerer']['Corruption'].ranks); track i;) {
          @if (mode == 'edit') {
            <input type="text" class="sphere" [ngModel]="spheres[i]" (ngModelChange)="setSphere(i, $event)" [ngModelOptions]="{standalone: true}" [attr.list]="formGroup.controls.sorceryAffects.value!.toLowerCase() + '-sphere-list'" />
          } @else {
            <div class="value">{{ spheres[i] }}</div>
          }
        }
      </div>
    </div>
  </div>
</div>
</div>
