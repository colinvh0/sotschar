<datalist id="faction-list">
  @for (faction of tup.factions; track faction;) {
    <option [attr.value]="faction"></option>
  }
</datalist>
<datalist id="health-sphere-list">
  @for (sphere of tup.spheres; track sphere;) {
    @if (sphere[1]) {
      <option [attr.value]="sphere[0]"></option>
    }
  }
</datalist>
<datalist id="morale-sphere-list">
  @for (sphere of tup.spheres; track sphere;) {
    @if (sphere[2]) {
      <option [attr.value]="sphere[0]"></option>
    }
  }
</datalist>
<div class="character-edit" [formGroup]="formGroup">
<section class="config" *ngIf="mode == 'edit'">
  <h1 class="head">Edit Character</h1>
  <div>
    <div><label><input type="checkbox" formControlName="configS2S"> Session 2 started</label></div>
    <div><label><input type="number" formControlName="configCharacterCount"> Number of Heroes</label></div>
    <div class="flex">
      <div>
        <div><label><input type="radio" formControlName="configAutoInvB" value="on"> <span class="invb-from-char-count">11</span></label></div>
        <div><input type="radio" formControlName="configAutoInvB" value=""> <input type="number" formControlName="configInvestigativeBuild" id="edit-char-config-invb"></div>
      </div>
      <div>
        <label>&nbsp;Investigative Points</label>
      </div>
    </div>
    <div><label><input type="number" formControlName="configGeneralBuild"> General Points</label></div>
    <div><label><input type="number" formControlName="configStaminaBuild"> Stamina Points</label></div>
    <div><label><input type="number" formControlName="configMinStamina"> Minimum Stamina</label></div>
    <div><label><input type="number" formControlName="configFreeAllies"> Free Allies</label></div>
    <div><label><input type="number" formControlName="configFreeEnemies"> Free Enemies</label></div>
    <div><label><input type="number" formControlName="advancement"> Advancement Points</label></div>
  </div>
</section>
<section class="config" *ngIf="mode == 'play'">
  <h1 class="head">Play Character</h1>
</section>
<section class="config" *ngIf="mode == 'print'">
  <h1 class="head">Print Character</h1>
</section>
<section class="mode"><button (click)="mode = 'edit'">Edit</button><button (click)="mode = 'play'">Play</button><button (click)="mode = 'print'">Print</button></section>
<div class="character-edit-grid character-sheet">
  <div class="panel name-panel">
    <div class="name-field">
      <label>
        <div class="label">Name</div>
        <div class="input"><input type="text" formControlName="name" class="large"></div>
      </label>
    </div>
    <div class="true-name-known-field">
      <label>
        <div class="label">True Name? <input type="checkbox" formControlName="tnk"></div>
        <div class="note">Check if True Name is known</div>
      </label>
    </div>
    <div class="profession-field">
      <label>
        <div class="label">Profession</div>
        <div class="input"><input type="text" formControlName="profession" class="large"></div>
      </label>
    </div>
    <div class="adjectives-field">
      <div class="label">Adjectives</div>
      @for (adj of adjectives; track adj; let i = $index) {
        <div class="input">
          <input type="text" id="adj{{i}}" [(ngModel)]="adj.value" [ngModelOptions]="{standalone: true}">
          <button class="del" (click)="delAdjective(i)">−</button>
        </div>
      }
      <div [ngClass]="'add' + ((adjectives.length >= 5) ? ' add-full' : '')"><button (click)="addAdjective()">+</button></div>
    </div>
  </div>
  <div class="logo"><img src="assets/logo.png" alt="Swords of the Serpentine"></div>
  <div class="panel portrait-panel">
    <div class="flex-column">
      <div class="head label">Character Portrait</div>
      <div class="input flex"><div>URL:</div><input type="url" formControlName="portraitUrl"></div>
      <div class="portrait" [ngStyle]="{'background-image': 'url(' + formGroup.controls.portraitUrl.value + ')'}"></div>
    </div>
  </div>
  <div class="panel drives-panel">
    <div>
      <div class="head label">What is Best in Life?</div>
      @for (drive of drives; track drive;) {
        <div class="input">
          @if (mode == 'edit') {
            <input type="text" [(ngModel)]="drive.value" [ngModelOptions]="{standalone: true}">
          } @else if (mode == 'play') {
            <div [ngClass]="'circle' + ((drive.pool >= 1) ? ' filled' : '')" (click)="drive.pool = (drive.pool == 1) ? 0 : 1"></div> {{ drive.value }}
          } @else if (mode == 'print') {
            <div class="circle" ></div> {{ drive.value }}
          }
        </div>
      }
    </div>
  </div>
  <section class="investigative-abilities subgrid">
    <h4 class="title1"><span>Investigative Abilities</span></h4>
    @for (category of invCatNames; track category) {
      <div [ngClass]="'panel ' + category.toLowerCase() + '-panel'">
        <div>
          <h5 class="head">{{ category }}</h5>
          @for (ability of invCats[category]; track ability;) {
            <div class="ability">
              <div class="ability-name">{{ ability.name }}</div>
              @if (ability.healthMorale) {
                <div class="label-tiny" *ngIf="invAbilities[category][ability.name].ranks >= 1">
                  @if (mode == 'edit') {
                    <div><label><input type="radio" formControlName="spotFrailty" value="Health"> Health</label></div>
                    <div><label><input type="radio" formControlName="spotFrailty" value="Morale"> Morale</label></div>
                  } @else {
                    {{ formGroup.controls.spotFrailty.value }}
                  }
                </div>
              }
              <div class="ability-value">
                @if (mode == 'edit') {
                  <div *ngFor="let i of aiToFrom(5)">
                    <div
                      [ngClass]="'circle' + ((invAbilities[category][ability.name].ranks >= i) ? ' filled' : '')"
                      (click)="setInvAbility(category, ability.name, i)"
                    ></div>
                  </div>
                } @else {
                  <div *ngFor="let i of aiToFrom(invAbilities[category][ability.name].ranks)">
                    @if (mode == 'play') {
                      @if (invAbilities[category][ability.name].pool >= i) {
                        <div class="circle filled" (click)="adjustInvPool(category, ability.name, false)"></div>
                      } @else {
                        <div class="circle" (click)="adjustInvPool(category, ability.name)"></div>
                      }
                    } @else if (mode == 'print') {
                      <div class="circle"></div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    }
  </section>
  <h4 class="title2"><span>General Abilities</span></h4>
  <h4 class="title3"><span>Allegiances</span></h4>
  <div class="panel general-panel">
    <div>
      @for (ability of genAbilityDefs; track ability;) {
        <div [ngClass]="'ability' + (ability.combat ? ' combat' : '')">
          <div class="ability-name">{{ ability.name }}</div>
          <div class="general-ability">
            <div class="ability-value">
              <div *ngFor="let i of aiToFrom(15)">
                <div
                  [ngClass]="'circle' + ((genAbilities[ability.name].ranks >= i) ? ' filled' : '') + (i == 8 ? ' talent' : '')"
                  (click)="setGenAbility(ability.name, i)"
                ></div>
              </div>
            </div>
            <div [ngClass]="'talent-name' + ((genAbilities[ability.name].ranks < 8) ? ' locked' : '')">{{ ability.talent }}</div>
          </div>
        </div>
      }
    </div>
  </div>
  <div class="panel allegiances-panel">
    <div>
      @for (adj of allegiances; track adj; let i = $index) {
        <div class="input">
          <input type="text" class="allegiances" id="alleg{{i}}" [(ngModel)]="allegiances[i].name" [ngModelOptions]="{standalone: true}" list="faction-list" />
          <div>
            <div class="ability-value">
              <div *ngFor="let j of aiToFrom(5)">
                <div
                  [ngClass]="'circle' + ((allegiances[i].ally.ranks >= j) ? ' filled' : '')"
                  (click)="allegiances[i].ally.ranks = j"
                >A</div>
              </div>
            </div>
            <div class="ability-value">
              <div *ngFor="let j of aiToFrom(5)">
                <div
                  [ngClass]="'circle red' + ((allegiances[i].enemy.ranks >= j) ? ' filled' : '')"
                  (click)="allegiances[i].enemy.ranks = j"
                >E</div>
              </div>
            </div>
          </div>
          <button class="del" (click)="delAllegiance(i)">−</button>
        </div>
      }
      <div [ngClass]="'add' + ((allegiances.length >= 12) ? ' add-full' : '')"><button (click)="addAllegiance()">+</button></div>
    </div>
  </div>
  <div class="panel wealth-panel">
    <label class="flex">
      <div class="label">Wealth</div>
      <input type="number" formControlName="wealth">
    </label>
    <div class="lifestyle">
      <div class="label">Lifestyle</div>
      <div>{{ tup.lifestyle[extAbilities.Lifestyle + 2] }}</div>
      <div class="ability-value">
        <div [ngClass]="'circle' + ((extAbilities.Lifestyle <= -2) ? ' filled' : '')" (click)="extAbilities.Lifestyle = -2">−2</div>
        <div [ngClass]="'circle' + ((extAbilities.Lifestyle <= -1) ? ' filled' : '')" (click)="extAbilities.Lifestyle = -1">−1</div>
        <div class="circle filled" (click)="extAbilities.Lifestyle = 0">0</div>
        <div [ngClass]="'circle' + ((extAbilities.Lifestyle >= 1) ? ' filled' : '')" (click)="extAbilities.Lifestyle = 1">+1</div>
        <div [ngClass]="'circle' + ((extAbilities.Lifestyle >= 2) ? ' filled' : '')" (click)="extAbilities.Lifestyle = 2">+2</div>
      </div>
    </div>
  </div>
  <div class="stamina-section">
    <div class="panel grid">
      <div class="label">Health</div>
      <div class="ability-value">
        <div *ngFor="let i of aiToFrom(15)">
          <div class="circle" [ngClass]="'circle' + ((genAbilities.Health.ranks >= i) ? ' filled' : '')" (click)="setGenAbility('Health', i)">{{ i }}</div>
        </div>
      </div>
      <div class="label">Morale</div>
      <div class="ability-value">
        <div *ngFor="let i of aiToFrom(15)">
          <div class="circle" [ngClass]="'circle' + ((genAbilities.Morale.ranks >= i) ? ' filled' : '')" (click)="setGenAbility('Morale', i)">{{ i }}</div>
        </div>
      </div>
    </div>
    <div class="table">
      <div class="label">Threshold</div>
      <div class="label">Armor</div>
      <div class="value">{{ extAbilities.HealthThreshold }}</div>
      <div class="value">{{ calcArmor() }}</div>
      <div class="value">{{ extAbilities.MoraleThreshold }}</div>
      <div class="value">{{ calcGrit() }}</div>
      <div class="label">Threshold</div>
      <div class="label">Grit</div>
    </div>
  </div>
  <h4 class="title2"><span>Gear</span></h4>
  <h4 class="title3"><span>Sorcerous Spheres</span></h4>
  <div class="panel gear-panel">
    <div>
      @for (_ of gear; track _; let i = $index) {
        <div class="input">
          <input type="checkbox" class="gear" id="gear-iconic{{i}}" [(ngModel)]="gear[i].iconic" [ngModelOptions]="{standalone: true}">
          <input type="text" class="gear" id="gear{{i}}" [(ngModel)]="gear[i].value" [ngModelOptions]="{standalone: true}">
          <button class="del" (click)="delGear(i)">−</button>
        </div>
      }
      <div [ngClass]="'add' + ((gear.length >= 100) ? ' add-full' : '')"><button (click)="addGear()">+</button></div>
    </div>
  </div>
  <div class="panel spheres-panel">
    <div class="flex-column">
      @if (invAbilities.Sorcerer.Corruption.ranks > 0) {
        <div class="label-tiny">Affects: <label><input type="radio" formControlName="sorceryAffects" value="health" /> Health</label>&nbsp;<label><input type="radio" formControlName="sorceryAffects" value="morale" /> Morale</label></div>
      }
      @for (i of aiToFrom(invAbilities.Sorcerer.Corruption.ranks); track i;) {
        <input type="text" class="sphere" id="sphere{{i}}" [(ngModel)]="spheres[i]" [ngModelOptions]="{standalone: true}" [attr.list]="formGroup.controls.sorceryAffects.value + '-sphere-list'" />
      }
    </div>
  </div>
</div>
</div>
